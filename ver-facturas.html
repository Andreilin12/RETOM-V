<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mostrar Facturas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2C3E50;
        }
        .container {
            width: 90%;
            margin: auto;
            padding-top: 20px;
           
        }
        .invoice {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 80mm; /* Tamaño de un ticket */
            text-align: left;
            font-size: 12px; /* Tamaño de fuente para tickets */
            font-family: 'Courier New', Courier, monospace; /* Fuente para tickets */
            margin-bottom: 20px;
        }
        h3, h4 {
            margin: 5px 0;
            text-align: center;      /* Alinear el texto al centro */
        }
        .button {
            margin-top: 20px;
            padding: 10px;
            background-color: #16a085;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #2e3e50;
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
                width: 21.6cm;
                height: 35.6cm;
                overflow: hidden; /* Evita el desplazamiento */
            }
            .container {
                width: 100%;
                padding: 0;
            }
            .invoice {
                width: 100%; /* Ancho completo para impresión */
                margin: 0;
                padding: 10mm; /* Espaciado interno para impresión */
            }
            .button {
                display: none; /* Ocultar botones al imprimir */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Listado de Facturas</h2>
        <div id="invoicesContainer"></div>
        <button class="button" id="reloadButton">Recargar Facturas</button>
    </div>

    <script type="module">
        // Importar Firebase y configurarlo
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
            authDomain: "inventario-35d6b.firebaseapp.com",
            databaseURL: "https://inventario-35d6b-default-rtdb.firebaseio.com",
            projectId: "inventario-35d6b",
            storageBucket: "inventario-35d6b.appspot.com",
            messagingSenderId: "266100399659",
            appId: "1:266100399659:web:92358d28cbd803c8a7d46e"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const invoicesContainer = document.getElementById('invoicesContainer');

        // Función para cargar y mostrar las facturas
        function loadInvoices() {
            const invoicesRef = ref(db, 'facturasnew');

            onValue(invoicesRef, (snapshot) => {
                invoicesContainer.innerHTML = ''; // Limpiar el contenedor antes de mostrar
                const invoices = snapshot.val();
                
                if (invoices) {
                    Object.entries(invoices).forEach(([key, invoice]) => {
                        const invoiceDiv = document.createElement('div');
                        invoiceDiv.classList.add('invoice');
                        invoiceDiv.setAttribute('data-id', key); // Almacenar la ID de la factura
                        invoiceDiv.innerHTML = `
                            <h3>${invoice.nombreNegocio || 'FACTURAS'}</h3>
                            <h3>${invoice.nombreNegocio || 'Nombre del Negocio'}</h3>
                            <p><strong>Dirección:</strong> ${invoice.direccion || 'Dirección del Negocio'}</p>
                            <p><strong>Factura ID:</strong> ${key}</p>
                            <p><strong>Fecha:</strong> ${invoice.fecha}</p>
                            <p><strong>Hora:</strong> ${invoice.hora}</p>
                            <h4>Productos:</h4>
                            <ul>
                                ${invoice.products.map(product => `
                                    <li>
                                        <strong>${product.producto}</strong><br>
                                        Cantidad: ${product.cantidad}<br>
                                        Precio unitario: ${product.precio.toFixed(2)}<br>
                                        Total: ${product.total.toFixed(2)}
                                    </li>
                                `).join('')}
                            </ul>
                            <p><strong>Total ITBIS:</strong> ${invoice.products.reduce((sum, p) => sum + p.itbisAmount, 0).toFixed(2)}</p>
                            <p><strong>Total Factura:</strong> ${invoice.products.reduce((sum, p) => sum + p.total, 0).toFixed(2)}</p>
                            <button class="button print-button" onclick="printInvoice('${key}')">Imprimir</button>
                        `;
                        invoicesContainer.appendChild(invoiceDiv);
                    });
                } else {
                    invoicesContainer.innerHTML = '<p>No hay facturas registradas.</p>';
                }
            }, {
                onlyOnce: true // Para que no escuche constantemente
            });
        }

        // Función para imprimir la factura
        window.printInvoice = function(invoiceId) {
            const invoiceDiv = document.querySelector(`.invoice[data-id='${invoiceId}']`); // Selecciona la factura por ID
            const printWindow = window.open('', '_blank', 'width=600,height=600');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Factura ${invoiceId}</title>
                        <style>
                            @media print {
                                body {
                                    margin: 0;
                                    padding: 0;
                                    width: 21.6cm; /* Ancho para la impresión */
                                    height: 35.6cm; /* Alto para la impresión */
                                }
                                .invoice {
                                    width: 100%; /* Ancho completo para impresión */
                                    margin: 0;
                                    padding: 10mm; /* Espaciado interno para impresión */
                                }
                                .button {
                                    display: none; /* Ocultar botones al imprimir */
                                }
                            }
                            body {
                                font-family: 'Courier New', Courier, monospace;
                            }
                        </style>
                    </head>
                    <body>
                        <h3>${invoiceDiv.querySelector('h3').innerText}</h3>
                        <p><strong>Dirección:</strong> ${invoiceDiv.querySelector('p strong').nextSibling.textContent.trim()}</p>
                        <p><strong>Factura ID:</strong> ${invoiceId}</p>
                        <p><strong>Fecha:</strong> ${invoiceDiv.querySelectorAll('p')[2].innerText}</p>
                        <p><strong>Hora:</strong> ${invoiceDiv.querySelectorAll('p')[3].innerText}</p>
                        <h4>Productos:</h4>
                        <ul>
                            ${invoiceDiv.querySelector('ul').innerHTML}
                        </ul>
                        <p><strong>Total ITBIS:</strong> ${invoiceDiv.querySelectorAll('p')[invoiceDiv.querySelectorAll('p').length - 2].innerText}</p>
                        <p><strong>Total Factura:</strong> ${invoiceDiv.querySelectorAll('p')[invoiceDiv.querySelectorAll('p').length - 1].innerText}</p>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        // Cargar facturas al inicio
        loadInvoices();

        // Recargar facturas al hacer clic en el botón
        document.getElementById('reloadButton').addEventListener('click', loadInvoices);
    </script>
</body>
</html>
